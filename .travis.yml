language: python

cache:

  - pip
  - npm

  - directories:
      - ${HOME}/virtualenv/
      - ${HOME}/.npm
      - ${HOME}/.cache/

matrix:

  fast_finish: true

  include:

    - os: linux
      dist: xenial
      python: "3.4"

    - os: linux
      dist: xenial
      python: "3.7"

    - os: osx
      language: generic
      env: PYTHON=3.4.4

  allow_failures:
    - os: osx

addons:
  apt:
    packages:
      - curl
      - build-essential
  homebrew:
    packages:
      - npm
      - mongodb

services:
  - mongodb

deploy:

  provider: heroku

  api_key:
    secure: "ODFvCKlTBaKeS3pZTzNRqklIfR1zyZ3WqIXf5gLisDFjGvzFXIFKBBt+mT7IMcm4seDylA3xbI4q0q8/0omO1n7WY/SDfTK0DqrTfSALPQQ0Vxq7mko9SzAnTEnK05mAGMbXpXpWfHWxJ/iaL/I1YpmnAyFiORa86oJPq+nbxILsu98o4TztXEebPvULiW7bLplQldgkiiS7vNtFeb7Xlv2kjaej2KaodtqEn0Ub9/4/s3CeznL2s13Cak4UgArNbBhjJGqgXqBEMxsYd2v8K32YxTo3nayom1YJPKmAoynKcSo7+XplhHPp7XgOL198smdiHXB3dzJTNScqCGXrUy8iJk3iwK8XeLQeia2rMAzSec/oYt6d2GxFm5VUvQOcKYKaBwc5pPWOI1rgW7dgQEJQ0qWrq/mDKq7fvwbnTVQwFKAlc3pVssn8oIzi61LpmDzkCjECA8MkBYnJZNgYNk5bAF84MfD6ME4uEqlFykymdIAK1oBBlcYE7jtrUxrVpR2KT0NYkcTE5Owww/N9yS5/DkhA6ZlzkWZ69jJns7MUVM44j9Ngtk6MkxQd5utUuZ54OU6Xt72vocsS447quog0mMClIH2L6aNovSH/3USXugTvkHmHm7QgKwHZ0tnQH7VgOQgmtfuDFvCOSiMzxeJKDLe2jNliZ5WF0TElfuA="

  run:
    - pushd coding

    - echo "Testing twitter fire scraper"
    - bash setup-scripts/test-tfs.sh

    - echo "Testing twitter fire scraper web API"
    - bash setup-scripts/test-tfs-webapi.sh

    - echo "twitter-fire-scraper-dashboard is starting up."
    - echo "Starting up Web API..."
    - bash setup-scripts/start-tfs-webapi.sh

    - echo "Starting dashboard..."
    - bash setup-scripts/start-tfs-dashboard.sh

    - popd

before_install:

  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then brew update; fi

  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then brew services start mongodb; fi

  # macOSX CI environment configuration: https://pythonhosted.org/CodeChat/.travis.yml.html
  - |
    if [ "$TRAVIS_OS_NAME" == "osx" ]; then
      brew update
      # Per the `pyenv homebrew recommendations <https://github.com/yyuu/pyenv/wiki#suggested-build-environment>`_.
      brew install openssl readline
      # See https://docs.travis-ci.com/user/osx-ci-environment/#A-note-on-upgrading-packages.
      # I didn't do this above because it works and I'm lazy.
      brew outdated pyenv || brew upgrade pyenv
      # virtualenv doesn't work without pyenv knowledge. venv in Python 3.3
      # doesn't provide Pip by default. So, use `pyenv-virtualenv <https://github.com/yyuu/pyenv-virtualenv/blob/master/README.md>`_.
      brew install pyenv-virtualenv
      pyenv install $PYTHON
      # I would expect something like ``pyenv init; pyenv local $PYTHON`` or
      # ``pyenv shell $PYTHON`` would work, but ``pyenv init`` doesn't seem to
      # modify the Bash environment. ??? So, I hand-set the variables instead.
      export PYENV_VERSION=$PYTHON
      export PATH="/Users/travis/.pyenv/shims:${PATH}"
      pyenv-virtualenv venv
      source venv/bin/activate
      # A manual check that the correct version of Python is running.
      python --version

      pip -V

      pip install pipenv

    fi

  - echo "Decrypting twitter API keys..."
  - openssl aes-256-cbc -K $encrypted_103c68a2b959_key -iv $encrypted_103c68a2b959_iv -in secrets.json.enc -out ~/secrets.json -d

  - echo "Installing npm..."
  - |
    if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then
      bash coding/setup-scripts/install-npm.sh
    fi

script:

  - echo "I am script!"

  - pushd coding

#  - echo "Testing twitter fire scraper"
#  - bash setup-scripts/test-tfs.sh
#
#  - echo "Testing twitter fire scraper web API"
#  - bash setup-scripts/test-tfs-webapi.sh
#
#  - echo "twitter-fire-scraper-dashboard is starting up."
#  - echo "Starting up Web API..."
#  - bash setup-scripts/start-tfs-webapi.sh
#
#  - echo "Starting dashboard..."
#  - bash setup-scripts/start-tfs-dashboard.sh

  - popd

after_failure:

  - echo "Log of twitter-fire-scraper-webapi:"
  - cat /tmp/flask.log

  - echo "Error log of twitter-fire-scraper-webapi:"
  - cat /tmp/flask.error.log


  - echo "Log of twitter-fire-scraper-dashboard:"
  - cat /tmp/node.log

  - echo "Error log of twitter-fire-scraper-dashboard:"
  - cat /tmp/node.error.log
